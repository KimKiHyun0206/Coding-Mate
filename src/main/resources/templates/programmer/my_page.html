<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            position: relative;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        nav {
            background-color: #333;
            color: #fff;
            width: 100%;
            padding: 15px 20px; /* 양쪽 여백 추가 */
            display: flex;
            justify-content: space-between; /* 항목들을 최대한 멀리 배치 */
            align-items: center;
        }

        .nav-left {
            display: flex;
        }

        .nav-right {
            display: flex;
        }

        nav a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px; /* 링크 사이 간격 조정 */
            font-weight: bold;
        }

        nav a:hover {
            color: #bbb;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 800px;
            margin: 30px auto;
        }

        .profile-info div {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 1.1em;
        }

        .profile-info div:last-child {
            border-bottom: none;
        }

        .profile-info strong {
            display: inline-block;
            width: 150px;
            color: #555;
            font-weight: bold;
        }

        .profile-info span, .profile-info a {
            color: #333;
        }

        .profile-info a {
            text-decoration: none;
        }

        .profile-info a:hover {
            text-decoration: underline;
            color: #007bff;
        }

        .tip-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f8ff;
            border: 1px solid #add8e6;
            border-radius: 5px;
            color: #333;
            font-size: 1em;
        }

        .tip-section strong {
            font-weight: bold;
            color: #007bff;
        }

        .edit-button-container {
            margin-top: 20px;
            text-align: right;
            display: flex; /* 버튼들을 가로로 배치 */
            justify-content: flex-end; /* 오른쪽 정렬 */
            gap: 10px; /* 버튼 사이 간격 */
        }

        .edit-button, .delete-button, .my-answer-button {
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .edit-button {
            background-color: #333;
            color: #fff;
            border: none;
        }

        .edit-button:hover {
            background-color: gray;
        }

        .delete-button {
            background-color: #dc3545; /* 빨간색 계열 */
            color: #fff;
            border: none;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        .my-answer-button {
            background-color: #333;
            color: #fff;
            border: none;
        }

        .my-answer-button:hover {
            background-color: gray;
        }
    </style>
</head>
<body>
<nav id="mainNav">
    <div class="nav-left">
        <a href="/">홈</a>
        <a href="/answer/list">풀이 목록</a>
    </div>
    <div class="nav-right">
        <a href="/login">로그인</a>
        <a href="/register">회원가입</a>
    </div>
</nav>

<div class="container">
    <h1>마이페이지</h1>
    <div class="profile-info">
        <div>
            <strong>이름:</strong> <span id="name"></span>
        </div>
        <div>
            <strong>GitHub:</strong> <a id="githubLink" href="" target="_blank"></a>
        </div>
        <div>
            <strong>이메일:</strong> <span id="email"></span>
        </div>
        <div>
            <strong>답변 수:</strong> <span id="numberOfAnswer"></span>
        </div>
    </div>

    <div class="tip-section" id="tipSection" style="display: none;">
        <strong>나만의 팁:</strong> <span id="tip"></span>
    </div>

    <div class="edit-button-container">
        <button class="my-answer-button" onclick="moveMyAnswer()">내가 작성한 풀이</button>
        <button class="edit-button" onclick="goToEditPage()">정보 수정</button>
        <button class="delete-button" onclick="deleteAccount()">탈퇴</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('DOMContentLoaded 시작');
        await check_and_refresh_token_for_nav_bar();
        try {
            const responseData = await fetchDataWithAuth('/api/v1/programmer/my-page');
            console.log('받아온 데이터:', responseData);
            const data = responseData.data;
            console.log(data);

            document.getElementById('name').textContent = data.name || '정보 없음';
            const githubLinkElement = document.getElementById('githubLink');
            githubLinkElement.href = 'https://github.com/' + data.githubId || '#';
            githubLinkElement.textContent = data.githubId || '없음';
            document.getElementById('email').textContent = data.email || '정보 없음';
            document.getElementById('numberOfAnswer').textContent = data.numberOfAnswer !== null ? data.numberOfAnswer : '0';

            if (data.tip) {
                document.getElementById('tip').textContent = data.tip;
                document.getElementById('tipSection').style.display = 'block';
            } else {
                document.getElementById('tipSection').style.display = 'none';
            }
        } catch (error) {
            console.error('마이페이지 정보 로딩 실패:', error);
            alert(`마이페이지 정보를 불러오는 데 실패했습니다: ${error.message}`);
        }
    });

    async function check_and_refresh_token_for_nav_bar() {
        console.log('checkAndRefreshAccessTokenForNavbar');
        const accessToken = localStorage.getItem('Coding-Mate-Auth');
        const refreshToken = localStorage.getItem('Coding-Mate-Auth-Ref');
        const navElement = document.getElementById('mainNav');
        const navLeft = navElement.querySelector('.nav-left');
        const navRight = navElement.querySelector('.nav-right');

        if (accessToken) {

            const response = await fetch('/api/v1/auth/access-token', {
                method: 'GET',
                headers: {
                    'Coding-Mate-Auth': accessToken
                }
            });

            if (response.ok) {
                update_navbar_authenticated(navLeft, navRight);
                return true;
            } else if (response.status === 401 && refreshToken) {
                const refreshResult = await refresh_access_token();
                if (refreshResult) {
                    update_navbar_authenticated(navLeft, navRight);
                    return true;
                }
            }
        }
    }

    async function refresh_access_token() {
        const refreshToken = localStorage.getItem('Coding-Mate-Auth-Ref');
        if (!refreshToken) {
            console.log('Refresh Token이 없습니다.');
            return false;
        }
        try {
            const refreshResponse = await fetch('/api/v1/auth/refresh-token', {
                method: 'GET',
                headers: {
                    'Coding-Mate-Auth-Ref': `${refreshToken}`
                }
            });

            if (refreshResponse.ok) {
                const newTokenData = await refreshResponse.json();
                if (newTokenData && newTokenData.data && newTokenData.data.accessToken && newTokenData.data.refreshToken) {
                    localStorage.setItem('Coding-Mate-Auth', newTokenData.data.accessToken);
                    localStorage.setItem('Coding-Mate-Auth-Ref', newTokenData.data.refreshToken);
                    console.log('토큰 갱신 성공:', newTokenData.data);
                    return true;
                } else {
                    console.error('새로운 토큰 응답에 accessToken 또는 refreshToken 없음:', newTokenData);
                    localStorage.removeItem('Coding-Mate-Auth');
                    localStorage.removeItem('Coding-Mate-Auth-Ref');
                    return false;
                }
            } else {
                console.error('Refresh Token 요청 실패:', refreshResponse.status);
                localStorage.removeItem('Coding-Mate-Auth');
                localStorage.removeItem('Coding-Mate-Auth-Ref');
                return false;
            }
        } catch (error) {
            console.error('Refresh Token 요청 중 오류:', error);
            localStorage.removeItem('Coding-Mate-Auth');
            localStorage.removeItem('Coding-Mate-Auth-Ref');
            return false;
        }
    }

    function update_navbar_authenticated(navLeft, navRight) {
        navLeft.innerHTML = `
        <a href="/">홈</a>
        <a href="/answer/list">풀이 목록</a>
    `;
        navRight.innerHTML = `
        <a href="/my-page">프로필</a>
        <a href="#" id="logoutButton">로그아웃</a>
    `;

        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', function (event) {
                event.preventDefault(); // <a> 태그의 기본 동작(페이지 이동) 방지
                logout(); // 로그아웃 함수 호출 (이전에 정의한 함수)
            });
        }
    }

    function logout() {
        fetch('/api/v1/auth/logout', { // 서버의 로그아웃 엔드포인트로 요청
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json' // 필요한 경우 Content-Type 설정
                // 필요한 경우 인증 헤더 (Authorization 등)를 포함할 수 있습니다.
                'Coding-Mate-Auth-Ref': localStorage.getItem('Coding-Mate-Auth-Ref')
            }
            // body는 일반적으로 필요하지 않습니다.
        })
            .then(response => {
                if (response.ok) {
                    localStorage.removeItem('Coding-Mate-Auth');
                    localStorage.removeItem('Coding-Mate-Auth-Ref');
                    alert('로그아웃 되었습니다.');
                    window.location.href = '/login'; // 로그인 페이지로 리다이렉트
                } else {
                    console.error('로그아웃 실패:', response.status);
                    alert('로그아웃에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('로그아웃 요청 실패:', error);
                alert('로그아웃 요청에 실패했습니다.');
            });
    }

    async function fetch_profile() {
        fetch('/api/v1/programmer/my-page', { // 실제 마이페이지 정보 API 엔드포인트
            headers: create_header()
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`프로필 정보를 불러오는 데 실패했습니다: ${errorData.message || '알 수 없는 오류'}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                populate_profile_form(data.data);
            })
            .catch(error => {
                console.error('프로필 정보 불러오기 오류:', error);
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorMessage').style.display = 'block';
            });
    }

    async function fetchDataWithAuth(url, options = {}) {
        const createdHeader = createAuthHeaderFromLocalStorage();
        const newOptions = {...options, headers: createdHeader};
        const response = await fetch(url, newOptions);

        if (!response.ok) {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                const errorData = await response.json();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || '알 수 없는 오류'}`);
            } else {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, response body: ${errorText || 'No response body'}`);
            }
        }
        return response.json();
    }

    function createAuthHeaderFromLocalStorage() {
        const authToken = localStorage.getItem('Coding-Mate-Auth');
        const headers = {};
        if (authToken) {
            headers['Coding-Mate-Auth'] = `${authToken}`;
        }
        return headers;
    }

    function moveMyAnswer() {
        window.location.href = '/my-page/answer';
    }

    function goToEditPage() {
        window.location.href = '/my-page/edit'; // 수정 페이지 URL로 이동
    }

    function deleteAccount() {
        if (confirm('정말로 계정을 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            fetch('/api/v1/auth/withdrawal', { // 실제 계정 탈퇴 API 엔드포인트로 변경해야 합니다.
                method: 'DELETE',
                headers: createAuthHeaderFromLocalStorage()
            })
                .then(response => {
                    if (response.status === 204) {
                        alert('계정이 성공적으로 탈퇴되었습니다.');
                        localStorage.removeItem('Coding-Mate-Auth');
                        localStorage.removeItem('Coding-Mate-Auth-Ref');
                        window.location.href = '/';
                    } else {
                        return response.json().then(errorData => {
                            throw new Error(`계정 탈퇴 실패: ${response.status}, message: ${errorData.message || '알 수 없는 오류'}`);
                        });
                    }
                })
                .catch(error => {
                    console.error('계정 탈퇴 실패:', error);
                    alert(`계정 탈퇴에 실패했습니다: ${error.message}`);
                });
        }
    }
</script>
</body>
</html>