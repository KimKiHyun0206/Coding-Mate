<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            position: relative;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        nav {
            background-color: #333;
            color: #fff;
            width: 100%;
            padding: 15px 20px; /* 양쪽 여백 추가 */
            display: flex;
            justify-content: space-between; /* 항목들을 최대한 멀리 배치 */
            align-items: center;
        }

        .nav-left {
            display: flex;
        }

        .nav-right {
            display: flex;
        }

        nav a {
            color: #fff;
            text-decoration: none;
            margin: 0 10px; /* 링크 사이 간격 조정 */
            font-weight: bold;
        }

        nav a:hover {
            color: #bbb;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 800px;
            margin: 30px auto;
        }

        .profile-info div {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 1.1em;
        }

        .profile-info div:last-child {
            border-bottom: none;
        }

        .profile-info strong {
            display: inline-block;
            width: 150px;
            color: #555;
            font-weight: bold;
        }

        .profile-info span, .profile-info a {
            color: #333;
        }

        .profile-info a {
            text-decoration: none;
        }

        .profile-info a:hover {
            text-decoration: underline;
            color: #007bff;
        }

        .tip-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f8ff;
            border: 1px solid #add8e6;
            border-radius: 5px;
            color: #333;
            font-size: 1em;
        }

        .tip-section strong {
            font-weight: bold;
            color: #007bff;
        }

        .edit-button-container {
            margin-top: 20px;
            text-align: right;
            display: flex; /* 버튼들을 가로로 배치 */
            justify-content: flex-end; /* 오른쪽 정렬 */
            gap: 10px; /* 버튼 사이 간격 */
        }

        .edit-button, .delete-button, .my-answer-button {
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .edit-button {
            background-color: #333;
            color: #fff;
            border: none;
        }

        .edit-button:hover {
            background-color: gray;
        }

        .delete-button {
            background-color: #dc3545; /* 빨간색 계열 */
            color: #fff;
            border: none;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        .my-answer-button {
            background-color: #333;
            color: #fff;
            border: none;
        }

        .my-answer-button:hover {
            background-color: gray;
        }
    </style>
</head>
<body>
<nav id="mainNav">
    <div class="nav-left">
        <a href="/">홈</a>
        <a href="/answer/list">풀이 목록</a>
    </div>
    <div class="nav-right">
        <a href="/login">로그인</a>
        <a href="/register">회원가입</a>
    </div>
</nav>

<div class="container">
    <h1>마이페이지</h1>
    <div class="profile-info">
        <div>
            <strong>이름:</strong> <span id="name"></span>
        </div>
        <div>
            <strong>GitHub:</strong> <a id="githubLink" href="" target="_blank"></a>
        </div>
        <div>
            <strong>이메일:</strong> <span id="email"></span>
        </div>
        <div>
            <strong>답변 수:</strong> <span id="numberOfAnswer"></span>
        </div>
    </div>

    <div class="tip-section" id="tipSection" style="display: none;">
        <strong>나만의 팁:</strong> <span id="tip"></span>
    </div>

    <div class="edit-button-container">
        <button class="my-answer-button" onclick="moveMyAnswer()">내가 작성한 풀이</button>
        <button class="edit-button" onclick="goToEditPage()">정보 수정</button>
        <button class="delete-button" onclick="deleteAccount()">탈퇴</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('DOMContentLoaded 시작');
        const isAuthenticated = await checkAndRefreshAccessToken();
        console.log('checkAndRefreshAccessToken 완료:', isAuthenticated);

        const navElement = document.getElementById('mainNav');
        const navLeft = navElement.querySelector('.nav-left');
        const navRight = navElement.querySelector('.nav-right');

        if (isAuthenticated) { // 토큰이 유효하거나 갱신에 성공했을 경우
            navLeft.innerHTML = `
            <a href="/">홈</a>
            <a href="/answer/list">풀이 목록</a>
            `;
            navRight.innerHTML = `
            <a href="/my-page">프로필</a>
            <a href="#" id="logoutButton">로그아웃</a>
            `;

            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function (event) {
                    event.preventDefault();
                    localStorage.removeItem('Coding-Mate-Auth');
                    localStorage.removeItem('Coding-Mate-Auth-Ref');
                    alert('로그아웃 되었습니다.');
                    window.location.href = '/';
                });
            }

            try {
                const responseData = await fetchDataWithAuth('/api/v1/programmer/my-page');
                console.log('받아온 데이터:', responseData);
                const data = responseData.data;
                console.log(data);

                document.getElementById('name').textContent = data.name || '정보 없음';
                const githubLinkElement = document.getElementById('githubLink');
                githubLinkElement.href = 'https://github.com/' + data.githubId || '#';
                githubLinkElement.textContent = data.githubId || '없음';
                document.getElementById('email').textContent = data.email || '정보 없음';
                document.getElementById('numberOfAnswer').textContent = data.numberOfAnswer !== null ? data.numberOfAnswer : '0';

                if (data.tip) {
                    document.getElementById('tip').textContent = data.tip;
                    document.getElementById('tipSection').style.display = 'block';
                } else {
                    document.getElementById('tipSection').style.display = 'none';
                }
            } catch (error) {
                console.error('마이페이지 정보 로딩 실패:', error);
                alert(`마이페이지 정보를 불러오는 데 실패했습니다: ${error.message}`);
            }
        } else {
            // 토큰이 없거나 갱신에 실패했을 경우 처리 (예: 로그인 페이지로 리다이렉트)
            console.log('인증 실패 또는 토큰 없음. 로그인 페이지로 이동.');
            window.location.href = '/login'; // 예시: 로그인 페이지로 리다이렉트
        }
        console.log('DOMContentLoaded 종료');
    });

    async function checkAndRefreshAccessToken() {
        console.log('checkAndRefreshAccessToken 시작');
        const accessToken = localStorage.getItem('Coding-Mate-Auth');
        const refreshToken = localStorage.getItem('Coding-Mate-Auth-Ref');

        if (!accessToken) {
            console.log('Access Token이 없습니다.');
            return false; // 명시적으로 false 반환 (Promise가 resolve 됨)
        }

        try {
            const response = await fetch('/api/v1/auth/access-token', {
                method: 'GET',
                headers: {
                    'Coding-Mate-Auth': accessToken
                }
            });

            if (response.ok) {
                console.log('Access Token이 유효합니다.');
                return true; // 유효하면 true 반환
            } else if (response.status === 401) {
                console.log('Access Token이 만료되었습니다. Refresh Token으로 갱신을 시도합니다.');
                if (refreshToken) {
                    const refreshResponse = await fetch('/api/v1/auth/refresh-token', {
                        method: 'GET',
                        headers: {
                            'Coding-Mate-Auth-Ref': `${refreshToken}`
                        }
                    });

                    if (refreshResponse.ok) {
                        const newTokenData = await refreshResponse.json();
                        const data = newTokenData.data;
                        if (data.refreshToken && data.accessToken) {
                            localStorage.setItem('Coding-Mate-Auth', `${data.accessToken}`);
                            localStorage.setItem('Coding-Mate-Auth-Ref', `${data.refreshToken}`);
                            console.log('Token 갱신 성공:', data);
                            return true; // 갱신 성공하면 true 반환
                        } else {
                            console.error('새로운 Access Token이 응답에 없습니다.');
                            localStorage.removeItem('Coding-Mate-Auth');
                            localStorage.removeItem('Coding-Mate-Auth-Ref');
                            return false; // 갱신 실패하면 false 반환
                        }
                    } else {
                        console.error('Refresh Token 요청 실패:', refreshResponse.status);
                        localStorage.removeItem('Coding-Mate-Auth');
                        localStorage.removeItem('Coding-Mate-Auth-Ref');
                        return false; // 갱신 실패하면 false 반환
                    }
                } else {
                    console.log('Refresh Token이 없습니다.');
                    localStorage.removeItem('Coding-Mate-Auth');
                    return false; // Refresh Token 없으면 false 반환
                }
            } else {
                console.error('Access Token 검사 실패:', response.status);
                return false; // 검사 실패하면 false 반환
            }
        } catch (error) {
            console.error('토큰 확인/갱신 중 오류 발생:', error);
            return false; // 오류 발생 시 false 반환
        } finally {
            console.log('checkAndRefreshAccessToken 종료');
        }
    }

    async function fetchDataWithAuth(url, options = {}) {
        const createdHeader = createAuthHeaderFromLocalStorage();
        const newOptions = {...options, headers: createdHeader};
        const response = await fetch(url, newOptions);

        if (!response.ok) {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                const errorData = await response.json();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || '알 수 없는 오류'}`);
            } else {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, response body: ${errorText || 'No response body'}`);
            }
        }
        return response.json();
    }

    function createAuthHeaderFromLocalStorage() {
        const authToken = localStorage.getItem('Coding-Mate-Auth');
        const headers = {};
        if (authToken) {
            headers['Coding-Mate-Auth'] = `${authToken}`;
        }
        return headers;
    }

    function moveMyAnswer() {
        window.location.href = '/my-page/answer';
    }

    function goToEditPage() {
        window.location.href = '/my-page/edit'; // 수정 페이지 URL로 이동
    }

    function deleteAccount() {
        if (confirm('정말로 계정을 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            fetch('/api/v1/auth/withdrawal', { // 실제 계정 탈퇴 API 엔드포인트로 변경해야 합니다.
                method: 'DELETE',
                headers: createAuthHeaderFromLocalStorage()
            })
                .then(response => {
                    if (response.status === 204) {
                        alert('계정이 성공적으로 탈퇴되었습니다.');
                        localStorage.removeItem('Coding-Mate-Auth');
                        localStorage.removeItem('Coding-Mate-Auth-Ref');
                        window.location.href = '/';
                    } else {
                        return response.json().then(errorData => {
                            throw new Error(`계정 탈퇴 실패: ${response.status}, message: ${errorData.message || '알 수 없는 오류'}`);
                        });
                    }
                })
                .catch(error => {
                    console.error('계정 탈퇴 실패:', error);
                    alert(`계정 탈퇴에 실패했습니다: ${error.message}`);
                });
        }
    }
</script>
</body>
</html>